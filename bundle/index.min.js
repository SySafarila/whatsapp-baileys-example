"use strict";var __getOwnPropNames=Object.getOwnPropertyNames,__commonJS=(e,t)=>function(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},require_whatsApp=__commonJS({"dist/whatsApp.js"(e){"use strict";var t=e&&e.__createBinding||(Object.create?function(u,n,i,o){o===void 0&&(o=i);var l=Object.getOwnPropertyDescriptor(n,i);(!l||("get"in l?!n.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return n[i]}}),Object.defineProperty(u,o,l)}:function(u,n,i,o){o===void 0&&(o=i),u[o]=n[i]}),a=e&&e.__setModuleDefault||(Object.create?function(u,n){Object.defineProperty(u,"default",{enumerable:!0,value:n})}:function(u,n){u.default=n}),s=e&&e.__importStar||function(){var u=function(n){return u=Object.getOwnPropertyNames||function(i){var o=[];for(var l in i)Object.prototype.hasOwnProperty.call(i,l)&&(o[o.length]=l);return o},u(n)};return function(n){if(n&&n.__esModule)return n;var i={};if(n!=null)for(var o=u(n),l=0;l<o.length;l++)o[l]!=="default"&&t(i,n,o[l]);return a(i,n),i}}(),r=e&&e.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(e,"__esModule",{value:!0}),e.whatsAppQr=e.whatsApp=void 0,e.connectToWhatsApp=h,e.isLoggedIn=b,e.logoutAndRestartWhatsApp=w;var p=s(require("@whiskeysockets/baileys")),c=s(require("axios")),v=r(require("node:fs/promises")),A=r(require("qrcode")),f=null;e.whatsApp=f;var g=null;e.whatsAppQr=g;function b(){return f!==null&&f.user!==void 0}async function w(u){if(f){console.log("Logging out...");try{await u.logout()}catch(n){console.error("Logout failed:",n)}try{await v.default.rm("auth_info_baileys",{recursive:!0,force:!0}),console.log("Auth info deleted.")}catch(n){console.error("Failed to delete auth folder:",n)}console.log("Restarting connection..."),h()}}async function h(){const{state:u,saveCreds:n}=await(0,p.useMultiFileAuthState)("auth_info_baileys"),i=(0,p.default)({printQRInTerminal:!0,auth:u});e.whatsApp=f=i,i.ev.on("creds.update",n),i.ev.on("connection.update",async o=>{const{connection:l,lastDisconnect:j,qr:y}=o;if(y){A.default.toDataURL(y,(d,O)=>{e.whatsAppQr=g=O});const _=process.env.RECEIVE_QR_URL;if(_)try{await c.default.post(_,{whatsAppQr:g},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log(`QR Sent to ${_}`)}catch(d){console.error(`Fail to send QR to ${_}`),d instanceof c.AxiosError&&console.error("Message:",d.response?.statusText??"No response")}else console.error("QR not sent anywhere because RECEIVE_QR_URL is undefined")}l==="close"?(console.info("CONNECTION CLOSE"),e.whatsAppQr=g=null,j?.error?.output?.statusCode===p.DisconnectReason.loggedOut?(console.log("User logged out, removing auth and restarting..."),await w(i)):(console.error("TRY RECONNECT"),h())):l==="open"&&(e.whatsAppQr=g=null,console.info("CONNECTED."))}),i.ev.on("messages.upsert",async o=>{o.messages[0].key.fromMe||(console.log({message:o.messages[0].message?.conversation,from:o.messages[0].key.remoteJid}),await i.sendMessage(o.messages[0].key.remoteJid,{react:{text:"\u{1F44C}",key:o.messages[0].key}}))})}}}),require_WhatsappController=__commonJS({"dist/controllers/WhatsappController.js"(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=require_whatsApp(),a=class{};a.getStatus=(s,r)=>{r.json({logged_in:(0,t.isLoggedIn)()})},a.getQR=(s,r)=>{r.json({qr:t.whatsAppQr})},a.logout=(s,r)=>{t.whatsApp?.user?((0,t.logoutAndRestartWhatsApp)(t.whatsApp),r.json({message:"Logout success"})):r.status(401).json({message:"WhatsApp not logged in"})},a.sendMessage=(s,r)=>{const{message:p,phone_number:c}=s.body;(!p||!c)&&r.status(400).json({message:"message or number are required"}),t.whatsApp&&t.whatsApp.user?t.whatsApp.sendMessage(c+"@s.whatsapp.net",{text:p}).then(()=>{r.json({message:"success"})}).catch(()=>{r.status(500).json({message:"failed"})}):r.status(401).json({message:"whatsapp client not started"})},e.default=a}}),require_express=__commonJS({"dist/express.js"(e){"use strict";var t=e&&e.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(e,"__esModule",{value:!0}),e.expressPort=void 0;var a=t(require("express")),s=t(require_WhatsappController()),r=(0,a.default)(),p=process.env.APP_PORT||3e3;e.expressPort=p,r.use(a.default.json()),r.get("/",(c,v)=>{v.json({message:"Hello world"})}),r.get("/status",s.default.getStatus),r.get("/qr",s.default.getQR),r.post("/logout",s.default.logout),r.post("/send-message",s.default.sendMessage),e.default=r}}),__createBinding=exports&&exports.__createBinding||(Object.create?function(e,t,a,s){s===void 0&&(s=a);var r=Object.getOwnPropertyDescriptor(t,a);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,s,r)}:function(e,t,a,s){s===void 0&&(s=a),e[s]=t[a]}),__setModuleDefault=exports&&exports.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=exports&&exports.__importStar||function(){var e=function(t){return e=Object.getOwnPropertyNames||function(a){var s=[];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(s[s.length]=r);return s},e(t)};return function(t){if(t&&t.__esModule)return t;var a={};if(t!=null)for(var s=e(t),r=0;r<s.length;r++)s[r]!=="default"&&__createBinding(a,t,s[r]);return __setModuleDefault(a,t),a}}();Object.defineProperty(exports,"__esModule",{value:!0});var express_1=__importStar(require_express()),whatsApp_1=require_whatsApp();(0,whatsApp_1.connectToWhatsApp)().then(()=>{express_1.default.listen(express_1.expressPort,()=>{console.info(`Express server running on port ${express_1.expressPort}`)})}).catch(e=>{console.error(e),process.exit(1)});
